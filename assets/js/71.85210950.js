(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{404:function(v,_,t){"use strict";t.r(_);var s=t(4),r=Object(s.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h1",{attrs:{id:"tcp-三次握手和四次挥手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#tcp-三次握手和四次挥手"}},[v._v("#")]),v._v(" TCP 三次握手和四次挥手")]),v._v(" "),_("h2",{attrs:{id:"建立连接-三次握手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#建立连接-三次握手"}},[v._v("#")]),v._v(" 建立连接-三次握手")]),v._v(" "),_("h3",{attrs:{id:"什么是三次握手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#什么是三次握手"}},[v._v("#")]),v._v(" 什么是三次握手？")]),v._v(" "),_("blockquote",[_("p",[v._v("简单来说：")]),v._v(" "),_("ol",[_("li",[v._v("客户端向服务器发送 SYN 报文，请求建立连接。")]),v._v(" "),_("li",[v._v("服务器收到 SYN 报文后，回复一个 SYN+ACK 的报文，表示同意建立连接。")]),v._v(" "),_("li",[v._v("客户端收到 SYN+ACK 报文后，再回复一个 ACK 报文，表示确认连接已经建立。")])]),v._v(" "),_("p",[v._v("SYN -- Synchronize 连接信号；ACK -- Acknowledgment 确认信号")])]),v._v(" "),_("p",[v._v("建立一个 TCP 连接需要“三次握手”，缺一不可：")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("一次握手")]),v._v(":\n"),_("ul",[_("li",[v._v("客户端发送带有 SYN（SEQ=x）标志的数据包 -> 服务端，")]),v._v(" "),_("li",[v._v("然后客户端进入 "),_("strong",[v._v("SYN_SEND")]),v._v(" 状态，等待服务器的确认；")])])]),v._v(" "),_("li",[_("strong",[v._v("二次握手")]),v._v(":\n"),_("ul",[_("li",[v._v("服务端发送带有 SYN+ACK(SEQ=y,ACK=x+1) 标志的数据包 –> 客户端，")]),v._v(" "),_("li",[v._v("然后服务端进入 "),_("strong",[v._v("SYN_RECV")]),v._v(" 状态")])])]),v._v(" "),_("li",[_("strong",[v._v("三次握手")]),v._v(":\n"),_("ul",[_("li",[v._v("客户端发送带有 ACK(ACK=y+1) 标志的数据包 –> 服务端，")]),v._v(" "),_("li",[v._v("然后客户端和服务器端都进入 "),_("strong",[v._v("ESTABLISHED")]),v._v("（established） 状态，完成 TCP 三次握手。")])])])]),v._v(" "),_("p",[v._v("当建立了 3 次握手之后，客户端和服务端就可以传输数据了。")]),v._v(" "),_("p",[v._v("具体如下图所示：")]),v._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/cmty256/imgs-blog@main/network/image.475j4lyffp60.webp",alt:"image"}})]),v._v(" "),_("h3",{attrs:{id:"为什么要三次握手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#为什么要三次握手"}},[v._v("#")]),v._v(" 为什么要三次握手？")]),v._v(" "),_("p",[v._v("三次握手的"),_("strong",[v._v("主要目的")]),v._v("是：确保客户端和服务器之间建立了可靠的连接，同时避免因重复的连接请求造成网络资源的浪费。")]),v._v(" "),_("ol",[_("li",[_("strong",[v._v("第一次握手")]),v._v("：\n"),_("ul",[_("li",[v._v("Client 什么都不能确认；")]),v._v(" "),_("li",[_("strong",[v._v("Server 确认了对方发送正常，自己接收正常")])])])]),v._v(" "),_("li",[_("strong",[v._v("第二次握手")]),v._v("：\n"),_("ul",[_("li",[_("strong",[v._v("Client 确认了：自己发送、接收正常，对方发送、接收正常")]),v._v("；")]),v._v(" "),_("li",[v._v("Server 确认了：对方发送正常，自己接收正常")])])]),v._v(" "),_("li",[_("strong",[v._v("第三次握手")]),v._v("：\n"),_("ul",[_("li",[v._v("Client 确认了：自己发送、接收正常，对方发送、接收正常；")]),v._v(" "),_("li",[_("strong",[v._v("Server 确认了：自己发送、接收正常，对方发送、接收正常")])])])])]),v._v(" "),_("h3",{attrs:{id:"tcp-为什么是三次握手-而不是两次或四次"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#tcp-为什么是三次握手-而不是两次或四次"}},[v._v("#")]),v._v(" TCP 为什么是三次握手，而不是两次或四次？")]),v._v(" "),_("p",[v._v("因为，三次握手是为了确保连接的可靠性和避免网络资源的浪费。而"),_("strong",[v._v("两次握手会存在上述的问题")]),v._v("，"),_("strong",[v._v("四次握手则会增加不必要的开销")]),v._v("，所以三次握手是一种较为合理的选择。")]),v._v(" "),_("h3",{attrs:{id:"第-2-次握手传回了-ack-为什么还要传回-syn"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第-2-次握手传回了-ack-为什么还要传回-syn"}},[v._v("#")]),v._v(" 第 2 次握手传回了 ACK，为什么还要传回 SYN？")]),v._v(" "),_("p",[v._v("服务端传回发送端所发送的 ACK 是为了告诉客户端：“我接收到的信息确实就是你所发送的信号了”，这表明从客户端到服务端的通信是正常的。")]),v._v(" "),_("p",[v._v("回传 SYN 则"),_("strong",[v._v("是为了建立并确认从服务端到客户端的通信")]),v._v("。")]),v._v(" "),_("blockquote",[_("p",[_("strong",[v._v("什么是 SYN ？")])]),v._v(" "),_("p",[v._v("SYN 同步序列编号(Synchronize Sequence Numbers) 是 TCP/IP 建立连接时使用的"),_("strong",[v._v("握手信号")]),v._v("。在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 SYN 消息，服务器使用 SYN-ACK 应答表示接收到了这个消息，最后客户机再以 ACK(Acknowledgement）消息响应。这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。")])]),v._v(" "),_("h2",{attrs:{id:"断开连接-四次挥手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#断开连接-四次挥手"}},[v._v("#")]),v._v(" 断开连接-四次挥手")]),v._v(" "),_("h3",{attrs:{id:"什么是四次挥手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#什么是四次挥手"}},[v._v("#")]),v._v(" 什么是四次挥手？")]),v._v(" "),_("blockquote",[_("p",[v._v("简单来说：")]),v._v(" "),_("ol",[_("li",[v._v("客户端向服务器发送 FIN 报文，请求关闭连接。")]),v._v(" "),_("li",[v._v("服务器收到 FIN 报文后，回复一个 ACK 报文，确认已经收到客户端的请求。")]),v._v(" "),_("li",[v._v("服务器再向客户端发送一个 FIN 报文，表示服务器也准备关闭连接。")]),v._v(" "),_("li",[v._v("客户端收到服务器的 FIN 报文后，回复一个 ACK 报文，确认已经收到服务器的请求，并关闭连接。")])])]),v._v(" "),_("p",[v._v("具体如下图所示：")]),v._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/cmty256/imgs-blog@main/network/image.52l9yh08gdo0.webp",alt:"image"}})]),v._v(" "),_("p",[v._v("断开一个 TCP 连接则需要“四次挥手”，缺一不可：")]),v._v(" "),_("ol",[_("li",[_("p",[_("strong",[v._v("第一次挥手")]),v._v("：")]),v._v(" "),_("ul",[_("li",[_("p",[v._v("客户端发送一个 FIN（SEQ=x） 标志的数据包->服务端，"),_("strong",[v._v("用来关闭客户端到服务器的数据传送")]),v._v("。")])]),v._v(" "),_("li",[_("p",[v._v("然后，客户端进入 "),_("strong",[v._v("FIN-WAIT-1")]),v._v(" 状态。")])])])]),v._v(" "),_("li",[_("p",[_("strong",[v._v("第二次挥手")]),v._v("：")]),v._v(" "),_("ul",[_("li",[v._v("服务器收到这个 FIN（SEQ=X）标志的数据包，它"),_("strong",[v._v("发送一个 ACK（ACK=x+1）标志的数据包 -> 客户端")]),v._v("。")]),v._v(" "),_("li",[v._v("然后，此时服务端进入 "),_("strong",[v._v("CLOSE-WAIT")]),v._v(" 状态，客户端进入 "),_("strong",[v._v("FIN-WAIT-2")]),v._v(" 状态。")])])]),v._v(" "),_("li",[_("p",[_("strong",[v._v("第三次挥手")]),v._v("：")]),v._v(" "),_("ul",[_("li",[_("strong",[v._v("服务端关闭与客户端的连接")]),v._v("并发送一个 FIN(SEQ=y) 标志的数据包 -> 客户端，请求关闭连接，")]),v._v(" "),_("li",[v._v("然后，服务端进入 "),_("strong",[v._v("LAST-ACK")]),v._v(" 状态。")])])]),v._v(" "),_("li",[_("p",[_("strong",[v._v("第四次挥手")]),v._v("：")]),v._v(" "),_("ul",[_("li",[v._v("客户端发送 ACK (ACK=y+1) 标志的数据包 -> 服务端并且进入 "),_("strong",[v._v("TIME-WAIT")]),v._v(" 状态，")]),v._v(" "),_("li",[v._v("服务端在收到 ACK (ACK=y+1) 标志的数据包后进入 CLOSE 状态。")]),v._v(" "),_("li",[v._v("此时，如果客户端等待 "),_("strong",[v._v("2MSL")]),v._v(" 后依然没有收到回复，就证明服务端已正常关闭，随后，客户端也可以关闭连接了。")])])])]),v._v(" "),_("p",[_("strong",[v._v("只要四次挥手没有结束，客户端和服务端就可以继续传输数据！")])]),v._v(" "),_("h3",{attrs:{id:"为什么要四次挥手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#为什么要四次挥手"}},[v._v("#")]),v._v(" 为什么要四次挥手？")]),v._v(" "),_("p",[v._v("TCP四次挥手的主要目的是："),_("strong",[v._v("确保客户端和服务器之间的连接能够正常关闭，并且避免因为未处理完的数据包而造成数据的丢失和不完整。")])]),v._v(" "),_("p",[v._v("即：为了确保连接的正常关闭和数据的完整性")]),v._v(" "),_("h3",{attrs:{id:"为什么不能把服务器发送的-ack-和-fin-合并起来-变成三次挥手"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#为什么不能把服务器发送的-ack-和-fin-合并起来-变成三次挥手"}},[v._v("#")]),v._v(" 为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手？")]),v._v(" "),_("p",[_("strong",[v._v("因为服务器收到客户端断开连接的请求时，可能还有一些数据没有发完")]),v._v("，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。")]),v._v(" "),_("blockquote",[_("p",[v._v("ACK 的作用是: 确认收到对方发送的数据包，")]),v._v(" "),_("p",[v._v("而 FIN 的作用是: 请求关闭连接。")])]),v._v(" "),_("h3",{attrs:{id:"如果第二次挥手时服务器的-ack-没有送达客户端-会怎样"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#如果第二次挥手时服务器的-ack-没有送达客户端-会怎样"}},[v._v("#")]),v._v(" 如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？")]),v._v(" "),_("p",[v._v("客户端没有收到 ACK 确认，"),_("strong",[v._v("会重新发送 FIN 请求")]),v._v("。")]),v._v(" "),_("h3",{attrs:{id:"为什么第四次挥手客户端需要等待-2-msl-报文段最长寿命-时间后才进入-closed-状态"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#为什么第四次挥手客户端需要等待-2-msl-报文段最长寿命-时间后才进入-closed-状态"}},[v._v("#")]),v._v(" 为什么第四次挥手客户端需要等待 2*MSL（报文段最长寿命）时间后才进入 CLOSED 状态？")]),v._v(" "),_("p",[v._v("因为第四次挥手时，"),_("strong",[v._v("客户端发送给服务器的 ACK 有可能会丢失")]),v._v("。")]),v._v(" "),_("p",[v._v("如果服务端因为某些原因而没有收到 ACK 的话，服务端就会重发 FIN，")]),v._v(" "),_("p",[v._v("如果客户端在 2*MSL 的时间内收到了 FIN，就会重新发送 ACK 并再次等待 2MSL，"),_("strong",[v._v("防止 Server 没有收到 ACK 而不断重发 FIN")]),v._v("。")]),v._v(" "),_("blockquote",[_("p",[v._v("假设客户端在发送 ACK 之后立即进入 CLOSED 状态（即关闭连接），同时 服务端没有接收到客户端的 ACK 确认，就会一直重发 FIN -- 请求关闭连接。")])]),v._v(" "),_("h3",{attrs:{id:"什么是-msl"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#什么是-msl"}},[v._v("#")]),v._v(" 什么是 MSL?")]),v._v(" "),_("p",[_("strong",[v._v("MSL(Maximum Segment Lifetime)")]),v._v(": 一个片段在网络中最大的存活时间，"),_("strong",[v._v("2MSL 就是一个发送和一个回复所需的最大时间")]),v._v("。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。")])])}),[],!1,null,null,null);_.default=r.exports}}]);